name: Evals

on:
  workflow_dispatch: # For manual trigger of evals
  push:
    branches:
      - '**'
jobs:
  end-to-end-evals:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write # This is needed to comment on the PR

    name: Evals
    steps:

      # TODO: Temp approach to check if evaluation status is "completed". Consider checking other passing critieria like the actual scores.
      - name: Extract Eval Results
        id: extract-eval-results
        run: |
          {
            echo "grader_scores<<EOF"
            echo '{
              "customer support tone grader": 4.0,
              "concise score grader": 5.0,
              "formatting score grader": 4.0,
              "multilingual score grader": 5.0,
              "humanized score grader": 5.0,
              "resolution oriented score grader": 5.0,
              "no pass phrases score grader": 5.0,
              "no reveal score grader": 5.0,
              "general toxicity score grader": 5.0,
              "cultural bias score grader": 5.0
            }'
            echo "EOF"
          } >> $GITHUB_OUTPUT
          echo "report_url=https://www.google.com" >> $GITHUB_OUTPUT
          echo ${{ github.event.pull_request.number }}
          echo "test"

      # Format eval results into a markdown table, output to `message` variable
      - name: Format Eval results
        id: format-eval-results
        run: |
          TABLE_MARKDOWN=$(echo '${{ steps.extract-eval-results.outputs.grader_scores }}' | jq -r '
            "| Grader | Score |",
            "| --- | --- |",
            (to_entries[] | "| \(.key) | \(.value) |")
          ')

          {
            echo "message<<EOF"
            echo "Commit SHA: ${{ env.CHECKOUT_REF }}"
            echo "Report URL: ${{ steps.extract-eval-results.outputs.report_url }}"
            echo "Evaulation Results:"
            echo "$TABLE_MARKDOWN"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Posting scores as PR comment
        uses: ./.github/actions/comment-pr
        with:
          body: ${{ steps.format-eval-results.outputs.message }}
          pr_number: 4
          repository: ${{ github.repository }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
